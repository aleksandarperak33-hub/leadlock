import{j as e,M as _,b as C,u as A,r as o,P as E,d as I,a as M,S as $}from"./index-C6CvHDG0.js";import{a as u}from"./client-BPQvj84Y.js";import{u as P}from"./useDebounce-CgSiU6vq.js";import{P as T}from"./PageHeader-BjaxPPSz.js";import{S as F}from"./SearchInput-BctKDIYz.js";import{S as R}from"./StatusDot-Dwh_QMkp.js";import{B}from"./Badge-GmErx7Do.js";import{f as y,U as D}from"./format-ybq0_Iis.js";import{L as O}from"./LeadStatusBadge-DOBR8ArV.js";import{A as U}from"./arrow-left-x6XvEO_x.js";import{L as q}from"./loader-circle-Cu5muWLC.js";import"./search-DsstUW0V.js";import"./en-US-8upN5vI8.js";const z={intake:"Intake",qualify:"Qualify",book:"Book",followup:"Follow-Up"};function K({messages:n=[]}){return n.length?e.jsx("div",{className:"space-y-4 py-4",children:n.map(a=>{const r=a.direction==="outbound";return e.jsx("div",{className:`flex ${r?"justify-end":"justify-start"}`,children:e.jsxs("div",{className:"max-w-[75%]",children:[r&&a.agent_id&&e.jsx("div",{className:"flex items-center gap-1 mb-1 justify-end",children:e.jsx(B,{variant:"neutral",size:"sm",children:z[a.agent_id]||a.agent_id})}),e.jsx("div",{className:`px-4 py-3 text-sm leading-relaxed ${r?"bg-orange-50 border border-orange-100 rounded-2xl rounded-br-sm text-gray-900":"bg-gray-50 border border-gray-100 rounded-2xl rounded-bl-sm text-gray-900"}`,children:a.content||"(empty message)"}),e.jsxs("div",{className:`flex items-center gap-2 mt-1.5 text-xs text-gray-400 ${r?"justify-end":""}`,children:[e.jsx("span",{children:a.created_at?y(new Date(a.created_at),"MMM d, h:mm a"):"—"}),r&&a.delivery_status&&e.jsx("span",{className:a.delivery_status==="delivered"?"text-emerald-500":a.delivery_status==="failed"?"text-red-500":"text-gray-400",children:a.delivery_status==="delivered"?"✓✓":a.delivery_status==="sent"?"✓":a.delivery_status==="failed"?"✗":""})]})]})},a.id)})}):e.jsxs("div",{className:"flex flex-col items-center justify-center py-16 text-gray-400",children:[e.jsx(_,{className:"w-8 h-8 mb-3",strokeWidth:1.5}),e.jsx("p",{className:"text-sm",children:"No messages yet"})]})}const Q=n=>["booked","qualified","completed"].includes(n)?"green":["qualifying","booking","follow_up"].includes(n)?"yellow":["opted_out"].includes(n)?"red":"gray";function le(){var N,w;const{leadId:n}=C(),a=A(),[r,h]=o.useState([]),[l,d]=o.useState(null),[f,m]=o.useState([]),[t,g]=o.useState(null),[c,S]=o.useState(!0),[j,k]=o.useState(""),b=P(j,300);o.useEffect(()=>{(async()=>{try{const i=await u.getLeads({per_page:M.CONVERSATIONS});h(i.leads||[])}catch(i){console.error("Failed to fetch leads:",i)}finally{S(!1)}})()},[]),o.useEffect(()=>{n&&d(n)},[n]),o.useEffect(()=>{if(!l)return;const s=async()=>{try{const[x,p]=await Promise.all([u.getLead(l),u.getConversations(l)]);g(x),m(p||[])}catch(x){console.error("Failed to fetch conversation:",x)}};s();const i=setInterval(s,E.CONVERSATIONS);return()=>clearInterval(i)},[l]);const L=s=>{d(s),a(`/conversations/${s}`,{replace:!0})},v=b?r.filter(s=>`${s.first_name||""} ${s.last_name||""}`.toLowerCase().includes(b.toLowerCase())):r;return e.jsxs("div",{className:"space-y-0",children:[e.jsx(T,{title:"Conversations"}),e.jsxs("div",{className:"flex h-[calc(100vh-180px)]",children:[e.jsxs("div",{className:"w-80 flex-shrink-0 border-r border-gray-200/50 bg-white hidden lg:flex lg:flex-col",children:[e.jsx("div",{className:"p-3 border-b border-gray-200/50",children:e.jsx(F,{value:j,onChange:k,placeholder:"Search leads..."})}),e.jsxs("div",{className:"flex-1 overflow-y-auto",children:[v.length===0&&e.jsx("p",{className:"text-sm text-gray-400 text-center py-8",children:"No leads found"}),v.map(s=>{var x,p;const i=l===s.id;return e.jsxs("button",{onClick:()=>L(s.id),className:`w-full text-left px-4 py-3 border-b border-gray-100 transition-colors cursor-pointer ${i?"bg-orange-50/50 border-l-2 border-l-orange-500":"hover:bg-gray-50/50 border-l-2 border-l-transparent"}`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-0.5",children:[e.jsxs("span",{className:"text-sm font-medium text-gray-900 truncate",children:[s.first_name||"Unknown"," ",s.last_name||""]}),e.jsx("span",{className:"text-xs text-gray-400 flex-shrink-0 ml-2",children:s.created_at?y(new Date(s.created_at),"MMM d"):"—"})]}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(R,{color:Q(s.state)}),e.jsx("span",{className:"text-xs text-gray-400 capitalize",children:(x=s.state)==null?void 0:x.replaceAll("_"," ")})]}),e.jsx("p",{className:"text-xs text-gray-400 truncate mt-0.5",children:(p=s.source)==null?void 0:p.replaceAll("_"," ")})]},s.id)})]})]}),e.jsx("div",{className:"flex-1 bg-[#FAFAFA] flex flex-col overflow-hidden",children:l?e.jsxs(e.Fragment,{children:[(t==null?void 0:t.lead)&&e.jsxs("div",{className:"px-6 py-4 border-b border-gray-200/50 bg-white",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{onClick:()=>{d(null),a("/conversations")},className:"lg:hidden text-gray-400 hover:text-gray-600 cursor-pointer",children:e.jsx(U,{className:"w-4 h-4"})}),e.jsx("div",{className:"w-9 h-9 rounded-xl bg-orange-50 flex items-center justify-center",children:e.jsx(D,{className:"w-4 h-4 text-orange-500"})}),e.jsxs("div",{children:[e.jsxs("p",{className:"text-sm font-medium text-gray-900",children:[t.lead.first_name||"Unknown"," ",t.lead.last_name||""]}),e.jsx("p",{className:"text-xs font-mono text-gray-400",children:t.lead.phone_masked})]}),e.jsxs("div",{className:"ml-auto flex items-center gap-3",children:[e.jsx(O,{status:t.lead.state}),e.jsx("span",{className:"text-xs capitalize text-gray-400",children:(N=t.lead.source)==null?void 0:N.replaceAll("_"," ")})]})]}),t.booking&&e.jsxs("div",{className:"mt-3 px-4 py-3 rounded-xl bg-emerald-50 border border-emerald-100",children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-xs font-medium text-emerald-700 mb-0.5",children:[e.jsx(I,{className:"w-3.5 h-3.5"}),"Appointment Booked"]}),e.jsxs("p",{className:"text-xs text-gray-500",children:[t.booking.appointment_date,t.booking.time_window_start&&` at ${t.booking.time_window_start}`,t.booking.tech_name&&` with ${t.booking.tech_name}`]})]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto px-6",children:e.jsx(K,{messages:f})}),e.jsx(V,{leadId:l,onSent:()=>{u.getConversations(l).then(s=>m(s||[]))}}),((w=t==null?void 0:t.events)==null?void 0:w.length)>0&&e.jsxs("div",{className:"px-6 py-3 max-h-28 overflow-y-auto border-t border-gray-200/50 bg-white",children:[e.jsx("p",{className:"text-xs font-medium text-gray-500 uppercase tracking-wider mb-2",children:"Timeline"}),e.jsx("div",{className:"space-y-1",children:t.events.slice(-5).map(s=>{var i;return e.jsxs("div",{className:"flex items-center gap-2 text-xs",children:[e.jsx("span",{className:"w-1.5 h-1.5 rounded-full bg-gray-300"}),e.jsx("span",{className:"text-gray-500",children:(i=s.action)==null?void 0:i.replaceAll("_"," ")}),s.duration_ms&&e.jsxs("span",{className:"font-mono text-gray-400",children:[s.duration_ms,"ms"]}),e.jsx("span",{className:"ml-auto font-mono text-gray-400",children:y(new Date(s.created_at),"h:mm a")})]},s.id)})})]})]}):e.jsxs("div",{className:"flex-1 flex flex-col items-center justify-center text-gray-400",children:[e.jsx(_,{className:"w-10 h-10 mb-3",strokeWidth:1.5}),e.jsx("p",{className:"text-sm",children:"Select a lead to view their conversation"})]})})]})]})}function V({leadId:n,onSent:a}){const[r,h]=o.useState(""),[l,d]=o.useState(!1),[f,m]=o.useState(null),t=async()=>{if(!(!r.trim()||l)){d(!0),m(null);try{await u.sendReply(n,r.trim()),h(""),a()}catch(c){m(c.message)}finally{d(!1)}}},g=c=>{c.key==="Enter"&&!c.shiftKey&&(c.preventDefault(),t())};return e.jsxs("div",{className:"px-6 py-3 border-t border-gray-200/50 bg-white",children:[f&&e.jsx("p",{className:"text-xs text-red-500 mb-2",children:f}),e.jsxs("div",{className:"flex items-end gap-2",children:[e.jsx("textarea",{value:r,onChange:c=>h(c.target.value),onKeyDown:g,placeholder:"Type a reply...",rows:1,className:"flex-1 px-4 py-2.5 text-sm bg-gray-50 border border-gray-200 rounded-xl outline-none focus:border-orange-300 focus:ring-2 focus:ring-orange-100 placeholder:text-gray-400 text-gray-900 transition-all resize-none"}),e.jsx("button",{onClick:t,disabled:!r.trim()||l,className:"flex items-center justify-center w-10 h-10 rounded-xl bg-orange-500 hover:bg-orange-600 text-white disabled:opacity-50 transition-colors cursor-pointer disabled:cursor-not-allowed flex-shrink-0","aria-label":"Send reply",children:l?e.jsx(q,{className:"w-4 h-4 animate-spin"}):e.jsx($,{className:"w-4 h-4"})})]})]})}export{le as default};
