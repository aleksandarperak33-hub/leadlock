import{j as e,r as d,C as M,Z as L,D as R}from"./index-BHeaMpcx.js";import{a as u}from"./client-CM7usSQg.js";import{P as k}from"./PageHeader-B70tmnmd.js";import{C as B}from"./circle-alert-CrLVGEbj.js";import{T as O}from"./trending-up-DpDefieV.js";import{F as V}from"./flask-conical-Brt26av9.js";function W({stages:t,className:a=""}){var l;if(!t)return null;const s=Array.isArray(t)?t.map(n=>[n.stage??n.name??String(n),Number(n.count??n.value??0)]):Object.entries(t).map(([n,c])=>[n,Number(c)]);if(s.length===0)return e.jsx("p",{className:"text-sm text-gray-400 text-center py-4",children:"No funnel data available."});const i=((l=s[0])==null?void 0:l[1])||1;return e.jsx("div",{className:`flex flex-col gap-2 ${a}`,children:s.map(([n,c],x)=>{const f=i>0?Math.round(c/i*100):0,g=x>0&&s[x-1][1]>0?Math.round(c/s[x-1][1]*100):null,j=Math.max(f,30),b=Math.max(95-x*15,40),y=Math.max(80-x*12,30);return e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("div",{className:"flex items-center justify-center rounded-xl py-3 px-4 transition-all duration-500",style:{width:`${j}%`,background:`linear-gradient(135deg, hsl(25, 95%, ${b}%) 0%, hsl(20, 90%, ${y}%) 100%)`},children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"text-sm font-semibold text-white capitalize",children:n.replace(/_/g," ")}),e.jsx("span",{className:"text-sm font-mono font-bold text-white/90",children:c.toLocaleString()}),e.jsxs("span",{className:"text-xs text-white/75",children:["(",f,"%)"]})]})}),g!==null&&e.jsxs("div",{className:"flex items-center gap-1 my-1",children:[e.jsx("div",{className:"w-px h-3 bg-gray-300"}),e.jsxs("span",{className:"text-xs text-gray-400 font-mono",children:[g,"% converted"]})]})]},n)})})}function h({title:t,icon:a,children:s}){return e.jsxs("div",{className:"bg-white border border-gray-200/50 rounded-2xl p-6 shadow-card mb-6",children:[e.jsxs("div",{className:"flex items-center gap-2.5 mb-4",children:[e.jsx("div",{className:"w-8 h-8 rounded-lg bg-orange-50 flex items-center justify-center",children:e.jsx(a,{className:"w-4 h-4 text-orange-500"})}),e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:t})]}),s]})}function C({label:t,value:a,numericValue:s,maxValue:i,suffix:l=""}){const n=typeof s=="number"?s:Number(s||0),c=i>0?Math.round(n/i*100):0;return e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"text-sm text-gray-700 w-40 shrink-0 truncate",children:t}),e.jsx("div",{className:"flex-1 h-3 rounded-full overflow-hidden bg-orange-100",children:e.jsx("div",{className:"h-full bg-orange-500 rounded-full transition-all duration-500",style:{width:`${Math.max(c,2)}%`}})}),e.jsxs("span",{className:"text-sm font-mono text-gray-900 w-20 text-right",children:[a,l]})]})}function I({tests:t}){return!t||t.length===0?e.jsx("p",{className:"text-sm text-gray-400",children:"No A/B tests running."}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-gray-100",children:[e.jsx("th",{className:"text-left text-xs font-medium text-gray-500 pb-2",children:"Test"}),e.jsx("th",{className:"text-right text-xs font-medium text-gray-500 pb-2",children:"Variant A"}),e.jsx("th",{className:"text-right text-xs font-medium text-gray-500 pb-2",children:"Variant B"}),e.jsx("th",{className:"text-right text-xs font-medium text-gray-500 pb-2",children:"Winner"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-50",children:t.map((a,s)=>e.jsxs("tr",{children:[e.jsx("td",{className:"py-2 text-gray-700 max-w-[180px] truncate",children:a.name||a.subject||`Test ${s+1}`}),e.jsx("td",{className:"py-2 text-right font-mono text-gray-600",children:a.variant_a_rate!=null?`${(a.variant_a_rate*100).toFixed(1)}%`:"—"}),e.jsx("td",{className:"py-2 text-right font-mono text-gray-600",children:a.variant_b_rate!=null?`${(a.variant_b_rate*100).toFixed(1)}%`:"—"}),e.jsx("td",{className:"py-2 text-right",children:a.winner?e.jsx("span",{className:"text-xs font-medium px-2 py-0.5 rounded-md bg-emerald-50 text-emerald-700",children:a.winner}):e.jsx("span",{className:"text-xs text-gray-400",children:"Running"})})]},a.id||s))})]})})}function D({data:t}){if(!t)return e.jsx("p",{className:"text-sm text-gray-400",children:"No data available."});const a=Array.isArray(t)?t:Object.entries(t).map(([i,l])=>({trade:i,cost:Number(l)||0}));if(a.length===0)return e.jsx("p",{className:"text-sm text-gray-400",children:"No data available."});const s=Math.max(...a.map(i=>Number(i.cost||0)),.01);return e.jsx("div",{className:"space-y-3",children:a.map((i,l)=>{const n=Number(i.cost||0);return e.jsx(C,{label:i.trade||"Overall",value:`$${n.toFixed(2)}`,numericValue:n,maxValue:s},i.trade||l)})})}function p(t){return t&&typeof t=="object"&&"data"in t?t.data:t}function K(){const[t,a]=d.useState(null),[s,i]=d.useState(null),[l,n]=d.useState(null),[c,x]=d.useState(null),[f,g]=d.useState(null),[S,j]=d.useState(!0),[b,y]=d.useState(null);d.useEffect(()=>{F()},[]);const F=async()=>{j(!0),y(null);try{const[r,o,m,A,w]=await Promise.allSettled([u.getAnalyticsPipeline(),u.getAnalyticsEmailPerf(),u.getAnalyticsAbTests(),u.getAnalyticsAgentCosts(),u.getAnalyticsCostPerLead()]);if(r.status==="fulfilled"&&a(p(r.value)),o.status==="fulfilled"&&i(p(o.value)),m.status==="fulfilled"&&n(p(m.value)),A.status==="fulfilled"&&x(p(A.value)),w.status==="fulfilled"&&g(p(w.value)),[r,o,m,A,w].every(E=>E.status==="rejected"))throw new Error("All analytics endpoints failed.")}catch(r){y(r.message||"Failed to load analytics.")}finally{j(!1)}};if(S)return e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx("div",{className:"w-6 h-6 border-2 border-orange-500 border-t-transparent rounded-full animate-spin"})});const N=(s==null?void 0:s.steps)||[],_=Math.max(...N.map(r=>Number(r.open_rate||0)),.01),v=c!=null&&c.total_by_agent?Object.entries(c.total_by_agent).map(([r,o])=>({agent:r,cost:Number(o)||0})):[],$=Math.max(...v.map(r=>r.cost),.01),T=Array.isArray(l)?l:(l==null?void 0:l.experiments)||(l?[l]:[]),P=(t==null?void 0:t.stages)||t;return e.jsxs("div",{className:"min-h-screen bg-[#FAFAFA]",children:[e.jsx(k,{title:"Analytics",subtitle:"Pipeline, email performance, A/B tests, and costs"}),b&&e.jsxs("div",{className:"mb-4 flex items-center gap-3 px-4 py-3 rounded-xl bg-red-50 border border-red-200/60",children:[e.jsx(B,{className:"w-4 h-4 text-red-500 shrink-0"}),e.jsx("p",{className:"text-sm text-red-700 flex-1",children:b}),e.jsx("button",{onClick:F,className:"text-xs font-medium text-red-600 hover:text-red-800 cursor-pointer",children:"Retry"})]}),P&&e.jsx(h,{title:"Pipeline Waterfall",icon:O,children:e.jsx(W,{stages:P})}),N.length>0&&e.jsx(h,{title:"Email Performance by Step",icon:M,children:e.jsx("div",{className:"space-y-3",children:N.map((r,o)=>{const m=Number(r.open_rate||0);return e.jsx(C,{label:`Step ${r.step??o+1}`,value:`${(m*100).toFixed(1)}%`,numericValue:m,maxValue:_},r.step??o)})})}),e.jsx(h,{title:"A/B Test Results",icon:V,children:e.jsx(I,{tests:T})}),v.length>0&&e.jsx(h,{title:"Agent Costs (Last 7 Days)",icon:L,children:e.jsx("div",{className:"space-y-3",children:v.map((r,o)=>e.jsx(C,{label:r.agent||`Agent ${o+1}`,value:`$${r.cost.toFixed(4)}`,numericValue:r.cost,maxValue:$},r.agent||o))})}),c&&e.jsxs("div",{className:"mb-6 text-right text-sm text-gray-500 font-mono",children:["Total AI spend (7d): $",Number(c.total_usd||0).toFixed(4)]}),e.jsx(h,{title:"Cost Per Lead by Trade",icon:R,children:e.jsx(D,{data:f})})]})}export{K as default};
